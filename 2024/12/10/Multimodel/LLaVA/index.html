<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>LLaVA(1)-Visual Instruction Tuning | HUI</title><meta name="author" content="HUI"><meta name="copyright" content="HUI"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="论文 Paper: https:&#x2F;&#x2F;arxiv.org&#x2F;abs&#x2F;2304.08485 代码 GitHub: https:&#x2F;&#x2F;github.com&#x2F;haotian-liu&#x2F;LLaVA 参考： https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;622907299 https:&#x2F;&#x2F;hackmd.io&#x2F;@YungHuiHsu&#x2F;HyMgBbjSa#Multimodal-LLaVA鍊成術-視覺指令調節">
<meta property="og:type" content="article">
<meta property="og:title" content="LLaVA(1)-Visual Instruction Tuning">
<meta property="og:url" content="http://example.com/2024/12/10/Multimodel/LLaVA/index.html">
<meta property="og:site_name" content="HUI">
<meta property="og:description" content="论文 Paper: https:&#x2F;&#x2F;arxiv.org&#x2F;abs&#x2F;2304.08485 代码 GitHub: https:&#x2F;&#x2F;github.com&#x2F;haotian-liu&#x2F;LLaVA 参考： https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;622907299 https:&#x2F;&#x2F;hackmd.io&#x2F;@YungHuiHsu&#x2F;HyMgBbjSa#Multimodal-LLaVA鍊成術-視覺指令調節">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/image-20241122154508143.png">
<meta property="article:published_time" content="2024-12-10T12:25:38.000Z">
<meta property="article:modified_time" content="2024-12-10T12:48:56.375Z">
<meta property="article:author" content="HUI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/image-20241122154508143.png"><link rel="shortcut icon" href="/img/122061154_p0_master1200.jpg"><link rel="canonical" href="http://example.com/2024/12/10/Multimodel/LLaVA/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'LLaVA(1)-Visual Instruction Tuning',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-12-10 20:48:56'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/bronya.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/87788970_p0_master1200.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清單</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音樂</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 電影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 關於</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/image-20241122154508143.png')"><nav id="nav"><span id="blog-info"><a href="/" title="HUI"><img class="site-icon" src="/img/319E33068A7ED73BAE7EB48FCE321DD4.jpg"/><span class="site-name">HUI</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清單</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音樂</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 電影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 關於</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">LLaVA(1)-Visual Instruction Tuning</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-12-10T12:25:38.000Z" title="发表于 2024-12-10 20:25:38">2024-12-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-12-10T12:48:56.375Z" title="更新于 2024-12-10 20:48:56">2024-12-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%9A%E6%A8%A1%E6%80%81%E7%B3%BB%E5%88%97/">多模态系列</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">11.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>37分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="LLaVA(1)-Visual Instruction Tuning"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/12/10/Multimodel/LLaVA/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2024/12/10/Multimodel/LLaVA/" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>论文 Paper: <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2304.08485">https://arxiv.org/abs/2304.08485</a></p>
<p>代码 GitHub: <a target="_blank" rel="noopener" href="https://github.com/haotian-liu/LLaVA">https://github.com/haotian-liu/LLaVA</a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/622907299">https://zhuanlan.zhihu.com/p/622907299</a></p>
<p><a target="_blank" rel="noopener" href="https://hackmd.io/@YungHuiHsu/HyMgBbjSa#Multimodal-LLaVA%E9%8D%8A%E6%88%90%E8%A1%93-%E8%A6%96%E8%A6%BA%E6%8C%87%E4%BB%A4%E8%AA%BF%E7%AF%80-Visual-Instruction-Tuning">https://hackmd.io/@YungHuiHsu/HyMgBbjSa#Multimodal-LLaVA鍊成術-視覺指令調節-Visual-Instruction-Tuning</a></p>
<h1 id="llava-visual-instruction-tuning"><a class="markdownIt-Anchor" href="#llava-visual-instruction-tuning"></a> LLaVA-Visual Instruction Tuning</h1>
<h2 id="摘要"><a class="markdownIt-Anchor" href="#摘要"></a> 摘要</h2>
<p>使用<strong>机器生成的Instruction followling数据</strong>对大规模语言模型（LLM）进行指令调优，已经证明可以提高它们在新任务上的zero-shot能力，但这一思想在多模态领域的探索较少。</p>
<p>本文首次尝试使用仅支持语言的GPT-4生成<strong>多模态语言-图像Instruction followling数据</strong>。通过对这些生成的数据进行指令调优，我们提出了<strong>LLaVA：大型语言和视觉助手</strong>，这是一个端到端训练的大型多模态模型，结合了视觉编码器和LLM，旨在进行通用的视觉和语言理解。</p>
<ul>
<li>为了促进未来在视觉指令跟随方面的研究，我们构建了两个评估基准，涵盖多样化且具有挑战性的应用任务。</li>
<li>实验结果表明，LLaVA展示了令人印象深刻的多模态对话能力，有时在未见过的图像/指令上展现出类似于多模态GPT-4的行为，并且在一个合成的多模态指令跟随数据集上，相较于GPT-4取得了85.1%的相对得分。在Science QA数据集上，LLaVA和GPT-4的协同作用达到了92.53%的新状态-of-the-art准确率。</li>
<li>我们公开了GPT-4生成的视觉指令调优数据、我们的模型和代码。</li>
</ul>
<h2 id="1-引言"><a class="markdownIt-Anchor" href="#1-引言"></a> 1. 引言</h2>
<p>人类通过多种渠道与世界互动，例如视觉和语言，每种渠道在表示和传达特定概念方面都有其独特的优势，从而有助于更好地理解世界。人工智能的核心目标之一是开发一个通用助手，能够有效地遵循多模态的视觉和语言指令，符合人类意图，在各种现实场景任务中发挥作用。</p>
<p>为此，研究界对开发具有语言增强功能的基础视觉模型表现出越来越大的兴趣，这些模型在开放世界视觉理解（如分类、检测、分割和描述生成）方面表现出强大能力，并能进行视觉生成和编辑。在这类工作中，每项任务通常由一个独立的大型视觉模型解决，任务指令被隐式考虑在模型设计中。此外，语言的作用通常仅限于描述图像内容，这虽然允许语言在将视觉信号映射到语言语义中发挥重要作用，但却导致模型的界面通常是固定的，缺乏用户指令的互动性和适应性。</p>
<p>另一方面，大型语言模型（LLM）展示了语言可以发挥更广泛的作用：作为通用助手的统一界面，其中各种任务指令可以用语言显式表示，并指导端到端训练的神经助手切换到感兴趣的任务进行解决。例如，最近ChatGPT和GPT-4的成功表明，经过对齐的大型语言模型在遵循人类指令方面的强大能力，并激发了开发开源LLM的极大兴趣。其中，LLaMA[49]是一个开源的LLM，与GPT-3的性能相匹配。Alpaca、Vicuna、GPT-4-LLM、利用各种机器生成的高质量Instruction followling样本来提高LLM的对齐能力，与专有LLM相比，产生了令人印象深刻的性能。重要的是，这一类的工作仅限于文本。</p>
<p>在本文中，我们提出了<strong>视觉指令调优</strong>，这是首次尝试将指令调优扩展到语言-图像多模态领域，为构建通用视觉助手铺平道路。我们的主要贡献包括：</p>
<ul>
<li><strong>多模态Instruction followling数据</strong>：我们提出了一种数据转换方法和pipline，利用ChatGPT/GPT-4将图像-文本对转化为适合的Instruction followling格式，以解决视觉-语言指令跟随数据的缺乏问题。</li>
<li><strong>大型多模态模型</strong>：通过将CLIP视觉编码器与语言解码器Vicuna连接起来，并在生成的视觉语言指令数据上进行端到端微调，我们开发了一个大规模多模态模型。实验结果验证了生成数据用于模型指令调优的有效性，并提供了构建通用指令跟随视觉代理的实用建议。</li>
<li><strong>多模态指令跟随基准</strong>：我们推出了LLaVA-Bench，包括两个具有挑战性的基准，涵盖多样化的配对图像、指令和详细注释。</li>
<li><strong>开源</strong>：我们公开发布了生成的多模态指令数据、代码库、模型检查点以及一个视觉聊天demo。</li>
</ul>
<h2 id="2-相关工作"><a class="markdownIt-Anchor" href="#2-相关工作"></a> 2. 相关工作</h2>
<p><strong>多模态指令跟随代理</strong>。在计算机视觉领域，现有的构建指令跟随代理的工作大致可以分为两类：</p>
<ul>
<li><strong>端到端训练的模型</strong>，这些模型分别针对每个具体的研究课题进行探索。例如，视觉-语言导航任务和Habitat要求具身AI代理遵循自然语言指令，并采取一系列动作以在视觉环境中完成目标。在图像编辑领域，给定一张输入图像和一条告诉代理该做什么的书面指令，InstructPix2Pix根据人类指令编辑图像。</li>
<li><strong>通过LangChain / LLMs协调不同模型的系统</strong>，如Visual ChatGPT、X-GPT 、MM-REACT、VisProg和ViperGPT。这些工作与我们在构建指令跟随代理方面有相同的目标，但我们更关注开发一个端到端训练的语言-视觉多模态模型，以处理多任务。</li>
</ul>
<p><strong>指令调优</strong>。在自然语言处理（NLP）领域，为了使大型语言模型（LLM）如GPT-3 、T5、PaLM 和OPT能够遵循自然语言指令并完成现实世界的任务，研究人员已经探索了<strong>LLM指令调优</strong>的方法，从而产生了如InstructGPT / ChatGPT 、FLAN-T5、FLAN-PaLM和OPT-IML等指令调优的对应模型。<font color="red">事实证明，这种简单的方法可以有效地提高LLM的zero-shot和few-shot泛化能力。</font>因此，将这一思想从NLP借用到计算机视觉领域是自然而然的。更广泛地说，基础模型中的teacher-student蒸馏思想也已经在其他领域进行研究，如图像分类。</p>
<blockquote>
<p><font color="YellowGreen">LLM指令调优可以有效地提高LLM的zero-shot和few-shot泛化能力,而且从NLP中借鉴思想到CV领域是自然而然的</font></p>
</blockquote>
<p><strong>Flamingo</strong>可以视为多模态领域中的GPT-3时刻，因为它在zero-shot任务迁移和上下文学习方面表现强劲。其他基于图像-文本对训练的大型多模态模型包括BLIP-2、FROMAGe和KOSMOS-1。PaLM-E是一个面向具身AI的多模态语言模型。基于最近“最佳”开源大预言模型 LLaMA，OpenFlamingo和LLaMA-Adapter是开源项目，使LLaMA能够使用图像输入，为构建开源多模态LLM铺平了道路。尽管这些模型在任务转移泛化表现上有前景，但它们并没有专门使用视觉-语言指令数据进行调优，因此它们在多模态任务中的表现通常不如text-only任务。本研究旨在填补这一空白，并研究其有效性。</p>
<blockquote>
<p><font color="YellowGreen">之前的一些多模态开源项目因为没有专门使用视觉-语言指令数据进行调优，因此它们在多模态任务中的表现通常不如text-only任务</font></p>
</blockquote>
<p>最后，值得注意的是，<strong>visual instruction tuning</strong>与<strong>visual prompt tuning</strong>是不同的：前者旨在提高模型的Instruction followling能力，而后者则旨在提高模型适应的参数效率。</p>
<h2 id="3-gpt辅助的视觉指令数据生成"><a class="markdownIt-Anchor" href="#3-gpt辅助的视觉指令数据生成"></a> 3. GPT辅助的视觉指令数据生成</h2>
<p>研究社区已经见证了大量公共多模态数据（例如图像-文本对）的激增，从<strong>CC</strong>到<strong>LAION</strong>不等。</p>
<p>然而，在<strong>多模态指令跟随数据</strong>方面，可用数据量较为有限，部分原因在于依赖人力数据收集的过程既耗时又缺乏明确的定义。<font color="red">受到近期GPT模型在文本标注任务中成功应用的启发，<strong>我们提出利用ChatGPT/GPT-4从广泛存在的图像对数据中收集多模态指令跟随数据</strong>。</font></p>
<p>对于一个图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">X_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 及其关联的标题<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">X_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，创建一组意在指导助手描述图像内容的问题 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">X_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>是很自然的。我们使用GPT-4生成此类问题列表（详细信息见附录）。因此，将图像-文本对扩展为其指令跟随版本的一种简单方法是：<font color="red"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mi>u</mi><mi>m</mi><mi>a</mi><mi>n</mi><mo>:</mo><msub><mi>X</mi><mi>q</mi></msub><msub><mi>X</mi><mi>v</mi></msub><mo>&lt;</mo><mi>S</mi><mi>T</mi><mi>O</mi><mi>P</mi><mo>&gt;</mo><mi>A</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>n</mi><mi>t</mi><mo>:</mo><msub><mi>X</mi><mi>c</mi></msub><mo>&lt;</mo><mi>S</mi><mi>T</mi><mi>O</mi><mi>P</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">Human: X_q X_v&lt;STOP&gt; Assistant: X_c&lt;STOP&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span></font>。</p>
<p>尽管这种扩展方式便宜易行，但其在指令和响应中缺乏多样性和深度推理。</p>
<p>为了缓解这一问题，我们利用仅支持语言的GPT-4或ChatGPT作为强大的techer（它们仅接受文本输入），以创建涉及视觉内容的Instruction followling数据。具体而言，为了将图像编码为可用于文本GPT的视觉特征，我们使用了两种符号表示方式：</p>
<ul>
<li><strong>标题</strong>通常从多个角度描述视觉场景；</li>
<li><strong>边界框</strong>通常用于定位场景中的对象，每个框都编码了对象的概念及其空间位置。表14的顶部展示了一个示例。</li>
</ul>
<p>这种符号表示方式允许我们将图像编码为LLM可识别的序列。我们使用COCO图像并生成<strong>三种类型</strong>的指令跟随数据。每种类型的示例见<strong>表1</strong>底部。对于每种类型，我们首先手动设计了一些示例。这些是数据收集中唯一的人类标注，并作为种子示例用于上下文学习以query GPT-4。</p>
<ul>
<li><strong>对话</strong>：我们设计了一段助手与询问此照片问题的人的对话。回答的语气仿佛助手正在观察图像并回答问题。提问内容多样，包括对象类型、数量、动作、位置及相对位置等问题，仅考虑答案明确的问题。详细提示见附录。</li>
<li><strong>详细描述</strong>：为了为图像提供丰富而全面的描述，我们创建了一组具有此意图的问题列表。然后提示GPT-4生成详细描述。</li>
<li><strong>复杂推理</strong>：在前两种类型专注于视觉内容本身的基础上，我们进一步创建了需要深入推理的问题。这些答案通常需要通过遵循严格逻辑的逐步推理过程得出。</li>
</ul>
<p><img src="image-20241122153752717.png" alt></p>
<center>表 1：说明指令遵循数据的一个示例。顶部块是用于提示 GPT 的标题和框等上下文，底部块显示三种类型的响应。请注意，视觉图像不是用于提示 GPT，我们仅在此展示作为参考。</center>
<p>我们总共收集了158,000个独特的语言-图像Instruction followling样本，其中包括58,000个对话、23,000个详细描述和77,000个复杂推理数据。在早期实验中，我们对比了ChatGPT和GPT-4的使用，发现GPT-4始终生成更高质量的Instruction followling数据，例如在空间推理方面表现优异。</p>
<blockquote>
<p><font color="YellowGreen">利用ChatGPT/GPT-4从广泛存在的图像对数据中收集多模态指令跟随数据。</font></p>
</blockquote>
<h2 id="4-视觉指令微调"><a class="markdownIt-Anchor" href="#4-视觉指令微调"></a> 4. 视觉指令微调</h2>
<h3 id="41-架构"><a class="markdownIt-Anchor" href="#41-架构"></a> 4.1 架构</h3>
<p>主要目标是有效利用预训练的大语言模型（LLM）和视觉模型的能力。网络架构如图1所示。我们选择了Vicuna作为LLM <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_\phi(\cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">⋅</span><span class="mclose">)</span></span></span></span>，参数化为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">\phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ϕ</span></span></span></span>，因为它在语言任务中的Instruction followling能力优于公开可用的模型检查点</p>
<p><img src="image-20241122154508143.png" alt></p>
<center>图1 LLaVA网络架构</center>
<p><strong>视觉编码器</strong></p>
<p>对于输入图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">X_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，我们采用预训练的CLIP视觉编码器ViT-L/14，它提供了视觉特征<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mi>v</mi></msub><mo>=</mo><mi>g</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>v</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Z_v = g(X_v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。在实验中，我们分别考虑了最后一个Transformer层前后的网格特征。我们使用一个简单的线性层将图像特征连接到词嵌入空间。具体来说，我们应用一个可训练的投影矩阵 W将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">Z_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>转换为语言嵌入token<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">H_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，其维度与语言模型中的词嵌入空间相同：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>H</mi><mi>v</mi></msub><mo>=</mo><mi>W</mi><mo>⋅</mo><msub><mi>Z</mi><mi>v</mi></msub><mo separator="true">,</mo><mi>w</mi><mi>i</mi><mi>t</mi><mi>h</mi><mtext> </mtext><msub><mi>Z</mi><mi>v</mi></msub><mo>=</mo><mi>g</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>v</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H_v = W \cdot Z_v, with \ Z_v = g(X_v)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mspace"> </span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>这样，我们得到了视觉标记序列<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">H_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。<font color="red">需要注意的是，我们的简单投影方案是轻量化的，这使我们能够快速迭代以数据为中心的实验。其他更复杂的图像和语言表示连接方案也可以考虑，例如Flamingo中的门控交叉注意力和BLIP-2中的Q-former或提供物体级别的其他视觉编码器，例如SAM。探索更有效、更复杂的LLaVA架构设计是我们未来工作的方向。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 代码会从 config 中读取以下字段：</span></span><br><span class="line"><span class="comment"># mm_projector_type：指定投影器的类型。</span></span><br><span class="line"><span class="comment"># mm_hidden_size：输入特征的大小。</span></span><br><span class="line"><span class="comment"># hidden_size：输出特征的大小。</span></span><br><span class="line"><span class="comment"># delay_load=False:一个可选参数，虽然在这段代码中没有被使用，但通常用于控制是否延迟加载某些资源。</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_vision_projector</span>(<span class="params">config, delay_load=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    projector_type = <span class="built_in">getattr</span>(config, <span class="string">&#x27;mm_projector_type&#x27;</span>, <span class="string">&#x27;linear&#x27;</span>)</span><br><span class="line">    <span class="comment"># 访问config的属性值config.mm_projector_type</span></span><br><span class="line">	</span><br><span class="line">   	<span class="comment"># 单层线性层</span></span><br><span class="line">    <span class="keyword">if</span> projector_type == <span class="string">&#x27;linear&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> nn.Linear(config.mm_hidden_size, config.hidden_size) <span class="comment"># 直接返回一个 PyTorch 的全连接层</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 多层MLP</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    mlp(\d+)x_gelu 是一个正则表达式，匹配形如 mlp2x_gelu 的字符串，如果匹配成功，mlp_gelu_match返回一个匹配对象，否则返回 None</span></span><br><span class="line"><span class="string">    ^: 表示字符串的开头。</span></span><br><span class="line"><span class="string">	mlp: 匹配字符串中固定的前缀 mlp。</span></span><br><span class="line"><span class="string">	(\d+): 捕获一组由一个或多个数字组成的内容。这里用来表示 MLP 的深度（层数）</span></span><br><span class="line"><span class="string">	x_gelu: 匹配固定的后缀 x_gelu。</span></span><br><span class="line"><span class="string">	$: 表示字符串的结尾</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    mlp_gelu_match = re.<span class="keyword">match</span>(<span class="string">r&#x27;^mlp(\d+)x_gelu$&#x27;</span>, projector_type) </span><br><span class="line">    <span class="keyword">if</span> mlp_gelu_match:</span><br><span class="line">        mlp_depth = <span class="built_in">int</span>(mlp_gelu_match.group(<span class="number">1</span>)) <span class="comment"># 如果 projector_type 是 &#x27;mlp3x_gelu&#x27;，那么 mlp_depth 会被解析为 3。</span></span><br><span class="line">        modules = [nn.Linear(config.mm_hidden_size, config.hidden_size)]</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, mlp_depth):</span><br><span class="line">            modules.append(nn.GELU())</span><br><span class="line">            modules.append(nn.Linear(config.hidden_size, config.hidden_size))</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*modules)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><font color="YellowGreen">说白了就是把图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">X_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>经过vision encoder(CLIP预训练之后的ViT)输出的图像特征经过单层linear或者双层MLP的projection得到可以被LLM接受的语言token序列，然后将与图像对应的语言指令<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">X_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>编码后的得到的token一起输入LLM得到最后的response。</font></p>
</blockquote>
<h3 id="42-训练"><a class="markdownIt-Anchor" href="#42-训练"></a> 4.2 训练</h3>
<p>对于每张图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">X_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，我们生成多轮对话数据 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msubsup><mi>X</mi><mi>q</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msubsup><mi>X</mi><mi>a</mi><mn>1</mn></msubsup><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msubsup><mi>X</mi><mi>q</mi><mi>T</mi></msubsup><mo separator="true">,</mo><msubsup><mi>X</mi><mi>a</mi><mi>T</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(X_q^1, X_a^1, \dots, X_q^T, X_a^T)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2244389999999998em;vertical-align:-0.383108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，其中 T为总轮数。我们将这些数据组织为一个序列，将所有的回答视为助手的响应，指令<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow><mi>t</mi></msubsup></mrow><annotation encoding="application/x-tex">X_{instruct}^t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.05222em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-2.441336em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span>在第 t 轮时的形式为：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow><mi>t</mi></msubsup><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>Randomly choose</mtext><mo stretchy="false">[</mo><msubsup><mi>X</mi><mi>q</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msub><mi>X</mi><mi>v</mi></msub><mo stretchy="false">]</mo><mtext> or </mtext><mo stretchy="false">[</mo><msub><mi>X</mi><mi>v</mi></msub><mo separator="true">,</mo><msubsup><mi>X</mi><mi>q</mi><mn>1</mn></msubsup><mo stretchy="false">]</mo><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>the first turn</mtext><mtext> </mtext><mi>t</mi><mo>=</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi>X</mi><mi>q</mi><mi>t</mi></msubsup><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>the remaining turns</mtext><mtext> </mtext><mi>t</mi><mo>&gt;</mo><mn>1</mn></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">X_{instruct}^t = \begin{cases} \text{Randomly choose} [X_q^1, X_v] \text{ or } [X_v, X_q^1], &amp; \text{the first turn} \, t = 1 \\ X_q^t, &amp; \text{the remaining turns} \, t &gt; 1 \end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0905559999999999em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8435559999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">Randomly choose</span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mord text"><span class="mord"> or </span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mpunct">,</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">the first turn</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">the remaining turns</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>这样就得到了多模态指令跟随序列的统一格式。</p>
<p>如表2所示。我们对LLM进行指令调优，使用其原始的自回归训练目标来预测目标回答。</p>
<p><img src="image-20241122160037402.png" alt></p>
<center>表 2：用于训练模型的输入序列。这里只展示了两个对话轮次；实际上，轮数根据指令跟随数据而变化。在我们当前的实现中，我们按照 Vicuna-v0设置系统消息 Xsystem-message 并设置 STOP = ###。该模型经过训练来预测assistant的答案以及在哪里停止，因此仅使用绿色序列/标记来计算自回归模型中的损失。</center>
<blockquote>
<p><font color="YellowGreen">表二展示的是两轮对话：</font></p>
<ul>
<li><font color="YellowGreen"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>s</mi><mi>y</mi><mi>s</mi><mi>t</mi><mi>e</mi><mi>m</mi><mo>−</mo><mi>m</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>a</mi><mi>g</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{system-message}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>表示人类和助手的对话</font></li>
<li><font color="YellowGreen"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow><mn>1</mn></msubsup></mrow><annotation encoding="application/x-tex">X_{instruct}^1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.072772em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span>是[输入图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">X_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, 第一轮次的提问<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>X</mi><mi>q</mi><mn>1</mn></msubsup></mrow><annotation encoding="application/x-tex">X_q^1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span></span></span></span>]或者[第一轮次的提问<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>X</mi><mi>q</mi><mn>1</mn></msubsup></mrow><annotation encoding="application/x-tex">X_q^1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span></span></span></span>, 输入图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">X_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>]</font></li>
<li><font color="YellowGreen"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>X</mi><mi>a</mi><mn>1</mn></msubsup></mrow><annotation encoding="application/x-tex">X_a^1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>是assistant第一轮次的回答</font></li>
<li><font color="YellowGreen"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">X_{instruct}^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.072772em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span>是[第一轮次的提问<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>X</mi><mi>q</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">X_q^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span></span></span></span>]</font></li>
<li><font color="YellowGreen"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>X</mi><mi>a</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">X_a^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>是assistant第二轮次的回答</font></li>
<li><font color="YellowGreen"><stop></stop>表示序列的结束符号，例如&quot;###&quot;</font></li>
<li><font color="YellowGreen">由于模型被训练为预测assistant的答案以及在哪里停止，因此仅使用绿色序列/标记来计算自回归模型中的损失。</font></li>
</ul>
<p><font color="YellowGreen">这种设计用于训练模型如何根据給定的問題和相应的图像进行交互。在第一回合，通过随机改变问题和图像的順序，模型能学习到不同的讯息呈现方式；而在后续的回合，模型則聚焦于如何基于新的問题继续对话。这样的训练方法旨在提高模型处理视觉讯息和语言指令的能力。</font></p>
</blockquote>
<p>具体来说，对于一个长度为L的序列，我们通过以下公式计算目标回答<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">X_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的概率：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>a</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>X</mi><mi>v</mi></msub><mo separator="true">,</mo><msub><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow></msub><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>L</mi></munderover><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>X</mi><mi>v</mi></msub><mo separator="true">,</mo><msub><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi><mo separator="true">,</mo><mo>&lt;</mo><mi>i</mi></mrow></msub><mo separator="true">,</mo><msub><mi>X</mi><mrow><mi>a</mi><mo separator="true">,</mo><mo>&lt;</mo><mi>i</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(X_a|X_v, X_{instruct}) = \prod_{i=1}^{L} p_\theta(x_i|X_v, X_{instruct,&lt;i}, X_{a,&lt;i})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.106005em;vertical-align:-1.277669em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mpunct mtight">,</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span> 为可训练的参数，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi><mtext>，</mtext><mo>&lt;</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{instruct，&lt;i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8607em;vertical-align:-0.17737em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span><span class="mord cjk_fallback mtight">，</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.17737em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>a</mi><mo separator="true">,</mo><mo>&lt;</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{a,&lt;i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mpunct mtight">,</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>分别是当前预测token <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>之前的指令和回答token。请参见表2了解预测token的具体示例。对于公式中的条件项，我们显式地添加 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">X_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>来强调图像对所有答案的基础作用，并省略<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>s</mi><mi>y</mi><mi>s</mi><mi>t</mi><mi>e</mi><mi>m</mi><mo>−</mo><mi>m</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>a</mi><mi>g</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{system-message}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>及所有先前的 <STOP> 以便于阅读。</STOP></p>
<blockquote>
<p><font color="YellowGreen">公式解释了在给定图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">X_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和指令<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{instruct}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的情況下，模型预测目标回答<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">X_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的机率：</font></p>
<ul>
<li><font color="YellowGreen">$p(X_a|X_v,X_{instruct}) <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>是在已知图像</mtext></mrow><annotation encoding="application/x-tex">是在已知图像</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">在</span><span class="mord cjk_fallback">已</span><span class="mord cjk_fallback">知</span><span class="mord cjk_fallback">图</span><span class="mord cjk_fallback">像</span></span></span></span>X_v<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>和指令</mtext></mrow><annotation encoding="application/x-tex">和指令</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">和</span><span class="mord cjk_fallback">指</span><span class="mord cjk_fallback">令</span></span></span></span>X_{instruct}<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>的条件下，模型产生正确回答</mtext></mrow><annotation encoding="application/x-tex">的条件下，模型产生正确回答</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">条</span><span class="mord cjk_fallback">件</span><span class="mord cjk_fallback">下</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">模</span><span class="mord cjk_fallback">型</span><span class="mord cjk_fallback">产</span><span class="mord cjk_fallback">生</span><span class="mord cjk_fallback">正</span><span class="mord cjk_fallback">确</span><span class="mord cjk_fallback">回</span><span class="mord cjk_fallback">答</span></span></span></span>X_a$的概率。</font></li>
<li><font color="YellowGreen"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>L</mi></msubsup></mrow><annotation encoding="application/x-tex">\prod_{i=1}^{L}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2809409999999999em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∏</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.981231em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span></span></span></span>表示对于所有的L个预测字词<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，将每个字词的条件概率相乘，L是序列的长度。</font></li>
<li><font color="YellowGreen"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>X</mi><mi>v</mi></msub><mo separator="true">,</mo><msub><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow></msub><mo separator="true">,</mo><mo>&lt;</mo><mi>i</mi><mo separator="true">,</mo><msub><mi>X</mi><mi>a</mi></msub><mo separator="true">,</mo><mo>&lt;</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_θ(x_i|X_v,X_{instruct},&lt;i,X_a,&lt;i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 是模型在参数θ下，根据已知的图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">X_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>、之前的指令<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow></msub><mo separator="true">,</mo><mo>&lt;</mo><mi>i</mi></mrow><annotation encoding="application/x-tex">X_{instruct},&lt;i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span>和之前的回答<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>a</mi></msub><mo separator="true">,</mo><mo>&lt;</mo><mi>i</mi></mrow><annotation encoding="application/x-tex">X_a,&lt;i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">i</span></span></span></span>，产生下一个字词<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的几率。</font></li>
<li><font color="YellowGreen">$X_{instruct},&lt;i $和 $X_a,&lt;i $分別代表在生成第i个字词之前的所有指令和回答字词。</font></li>
</ul>
</blockquote>
<p>对于LLaVA模型的训练，我们采用了两阶段的指令调优过程。</p>
<p><strong>阶段1：特征对齐的预训练</strong></p>
<ul>
<li>
<p>为了在<strong>概念覆盖</strong>和<strong>训练效率</strong>之间取得平衡，首先对CC3M数据集进行了筛选，保留了595K图像-文本对。详细的筛选过程请参见附录(图7)。</p>
</li>
<li>
<p>将图像-文本对使用第3节中描述的简单扩展方法（<font color="YellowGreen">感觉这里就是用的不同方法扩展</font>）转化为指令跟随数据。<strong>每个样本可以视为单轮对话</strong>。(<font color="YellowGreen">这意味着每个样本对应的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mtext>Randomly choose</mtext><mo stretchy="false">[</mo><msub><mi>X</mi><mi>q</mi></msub><mo separator="true">,</mo><msub><mi>X</mi><mi>v</mi></msub><mo stretchy="false">]</mo><mtext> or </mtext><mo stretchy="false">[</mo><msub><mi>X</mi><mi>v</mi></msub><mo separator="true">,</mo><msub><mi>X</mi><mi>q</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">X_{instruct} =  \text{Randomly choose} [X_q, X_v] \text{ or } [X_v, X_q]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord text"><span class="mord">Randomly choose</span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mord text"><span class="mord"> or </span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></font>)</p>
</li>
<li>
<p>为了构建公式（2）中的输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{instruct}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，对于每张图像 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">X_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，随机采样一个问题 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">X_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>，(<font color="YellowGreen">随机采样的问题如下图所示，也可见附录E表11</font>)，即要求助手简要描述该图像的语言指令。真实的预测答案 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">X_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是原始标题。</p>
</li>
<li>
<p><strong>在训练过程中，我们保持视觉编码器和LLM的权重不变，仅对投影矩阵W进行训练，以最大化公式（3）的似然</strong>。</p>
</li>
</ul>
<p><img src="image-20241126182527339.png" alt></p>
<p>通过这种方式，图像特征 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">H_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 可以与预训练的LLM词嵌入进行对齐。<font color="red">这个阶段可以理解为为冻结的LLM训练一个兼容的视觉标记器。</font></p>
<blockquote>
<p><font color="YellowGreen">预训练阶段冻结LLM和视觉编码器，目的是训练一个很好的将图像特征序列转换为语言标记token的projection。</font></p>
<ul>
<li><font color="YellowGreen">预训练阶段每个样本的对话只有一轮，且</font></li>
<li><font color="YellowGreen">如上图所示，“human”,&quot;value&quot;对应的是随机采样的问题<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">X_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>,“gpt”,&quot;value&quot;对应的是gpt生成的真实预测答案<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">X_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</font></li>
<li><font color="YellowGreen">所以预训练时输入的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{instruct}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>就是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msubsup><mi>X</mi><mi>q</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msub><mi>X</mi><mi>v</mi></msub><mo stretchy="false">]</mo><mtext> or </mtext><mo stretchy="false">[</mo><msub><mi>X</mi><mi>v</mi></msub><mo separator="true">,</mo><msubsup><mi>X</mi><mi>q</mi><mn>1</mn></msubsup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[X_q^1, X_v] \text{ or } [X_v, X_q^1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mord text"><span class="mord"> or </span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span>,输出的LLM response是预测的caption。</font></li>
</ul>
</blockquote>
<p><strong>阶段2：端到端微调</strong>(Visual Instruction Tuning)<br>
<font color="red">我们始终保持视觉编码器的权重冻结，并继续更新投影层和LLM的预训练权重</font>；即在公式（3）中，训练的参数为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi><mo>=</mo><mo stretchy="false">{</mo><mi>W</mi><mo separator="true">,</mo><mi>ϕ</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\theta = \{W, \phi\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">ϕ</span><span class="mclose">}</span></span></span></span>。我们考虑了两种特定的应用场景：</p>
<ul>
<li><strong>多模态聊天机器人</strong>。我们通过在第3节中介绍的158K语言-图像指令跟随数据上进行微调，开发了一个聊天机器人。在三种类型的回答中，<strong>conversaion</strong>是多轮的，而<strong>详细描述</strong>和<strong>复杂推理</strong>是单轮的。在训练中，所有类型的数据都被均匀采样。</li>
<li><strong>科学问答</strong>。我们在<strong>ScienceQA</strong>基准数据集上研究我们的方法。这是第一个大规模的多模态科学问答数据集，注释了详细的讲解和解释。每个问题提供了一个自然语言或图像的上下文，助手在自然语言中提供推理过程，并从多个选项中选择答案。在训练过程中，我们将数据组织为<strong>单轮对话</strong>，问题和上下文作为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>i</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{instruct}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，推理和答案作为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">X_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</li>
</ul>
<blockquote>
<p><font color="YellowGreen">Coco,GQA,OCR-VQA,TextVQA,VisualGenome构成了最终的指令微调数据集。注意这是llava-v1.0，所以只有158k，在llava-v1.5中是665k</font></p>
</blockquote>
<h2 id="5-实验"><a class="markdownIt-Anchor" href="#5-实验"></a> 5. 实验</h2>
<p>我们通过两种主要的实验设置评估LLaVA在<strong>指令跟随</strong>和<strong>视觉推理</strong>能力方面的表现：</p>
<ul>
<li>多模态聊天机器人</li>
<li>ScienceQA数据集</li>
</ul>
<p>我们使用8个A100 GPU训练所有模型，并遵循Vicuna的超参数。在CC-595K过滤后的子集上对模型进行1个epoch的预训练，学习率为2e-3，批量大小为128；随后在提出的LLaVA-Instruct-158K数据集上进行3个epoch的微调，学习率为2e-5，批量大小为32。更多训练细节见附录。</p>
<h3 id="51-多模态聊天机器人"><a class="markdownIt-Anchor" href="#51-多模态聊天机器人"></a> 5.1 多模态聊天机器人</h3>
<p>我们开发了一个聊天机器人演示，展示LLaVA的图像理解和对话能力，并研究LLaVA在<strong>消化视觉输入</strong>和<strong>表现指令跟随</strong>能力方面的表现。</p>
<p>首先，我们使用了原始GPT-4论文中的例子（如表3，更多例子见附录），这些例子需要深入的图像理解。为了进行比较，我们引用了多模态GPT-4论文中的提示和响应，同时查询BLIP-2和OpenFlamingo模型检查点以获取它们的响应。</p>
<p><img src="image-20241122162647965.png" alt></p>
<center>表 3：来自 GPT-4 论文 的示例提示，用于比较视觉推理和聊天功能。与 BLIP-2和 OpenFlamingo相比，LLaVA 准确地遵循用户的指令，而不是简单地描述场景。 LLaVA 提供比 GPT-4 更全面的响应。即使只是被要求描述图像，LLaVA 也会识别出图像的非典型方面。</center>
<p>令人惊讶的是，尽管LLaVA是在一个小规模的多模态指令跟随数据集（大约80K张独特图片）上进行训练的，但它在这些示例上展现出了与多模态GPT-4相似的推理结果。需要注意的是，虽然这些图像对于LLaVA来说是不在训练数据集内的，但LLaVA仍然能够理解场景并遵循问题指令，给出合理的回答。相比之下，BLIP-2和OpenFlamingo则更多聚焦于描述图像，而不是根据用户的指令给出合适的回答。</p>
<p><strong>定量评估</strong><br>
为了系统地理解LLaVA的表现，我们提出了一个<strong>定量指标</strong>来衡量模型在多模态数据上的指令跟随能力。<font color="red">我们借鉴了<strong>Vicuna</strong>的方法，利用GPT-4来评估生成的响应质量。</font>具体来说:</p>
<ol>
<li>我们创建了由<strong>图像</strong>、<strong>真实文本描述</strong>和<strong>问题</strong>组成的三元组。候选模型（如LLaVA）基于问题和图像<strong>预测答案</strong>。</li>
<li>为了提供一个近似的理论上限，我们使用基于问题和真实文本描述的<strong>参考预测</strong>，通过纯文本GPT-4生成。</li>
<li>在获得两种模型的响应后，我们将问题、视觉信息（以文本描述的形式）和两位助手生成的回答输入到评判者（即纯文本GPT-4）中。<strong>评判者评估回答的有用性、相关性、准确性和详细程度，并给出一个1到10的评分，分数越高表示总体表现越好。同时，评判者还被要求提供评估的详细解释，以帮助我们更好地理解评分的依据</strong>。</li>
</ol>
<p>我们报告了相对于使用真实图像描述作为视觉输入的纯文本GPT-4模型的相对分数，并创建了两个基准来评估模型性能。</p>
<ul>
<li><strong>LLaVA-Bench（COCO）</strong><br>
我们从COCO-Val-2014中随机选择了30张图像，并为每张图像生成了三种类型的问题（<strong>对话</strong>、<strong>详细描述</strong>和<strong>复杂推理</strong>），总共90个问题。<font color="red">这一基准研究了模型在一致的视觉输入下的对齐行为和能力。</font>我们通过改变训练数据集研究了不同类型指令跟随数据的效果，结果见表4。<br>
首先，经过指令调优，模型的用户指令跟随能力显著提高，分数提升超过50点。其次，添加少量的详细描述和复杂推理问题使模型的总体能力提高了7点。此外，这还提升了模型在对话类问题上的表现，表明推理能力的提高对对话能力有补充作用。最后，三种数据类型结合使用时，模型在性能上达到了最佳（85.1%）。</li>
<li><strong>LLaVA-Bench（开放领域）</strong><br>
为了评估模型在更具挑战性任务中的表现及其在新领域中的<strong>泛化能力</strong>，我们收集了一个包含24张图片的多样化数据集，共有60个问题，包括室内和室外场景、表情包、绘画、素描等，<strong>并为每张图片关联了高度详细的人工注释和合适的问题选择</strong>。我们在表5中对比了LLaVA、BLIP-2和OpenFlamingo的表现。<br>
得益于视觉指令调优，LLaVA在性能上显著优于BLIP-2（+29%）和OpenFlamingo（+48%）。相较于使用真实标签的纯文本GPT-4，LLaVA在复杂推理问题上达到了令人印象深刻的81.7%性能，总体得分为67.3%。</li>
</ul>
<p><img src="image-20241122164347253.png" alt></p>
<center>表 4：使用不同训练数据在 LLaVA-Bench (COCO) 上进行消融。我们报告相对分数，使用真实图像标题和边界框作为视觉输入纯文本 GPT-4 模型。我们用模型输出的答案和 GPT-4 的答案（纯文本）提示 GPT-4，并让它比较两个响应并给出评级和解释。</center>
<p><img src="image-20241122165000489.png" alt></p>
<center>表 5：使用 LLaVA-Bench (In-theWild) 上的相对分数进行指令遵循能力比较。结果以平均值±标准差的格式报告。对于前三行，我们报告了三个推理运行。 LLaVA 的表现明显优于其他产品。 † 对于给定的一组LLaVA decoding sequences，我们通过查询GPT-4 3次来评估； GPT-4给出了一致的评价。</center>
<p><strong>局限性</strong><br>
这一开放领域的LLaVA-Bench基准被设计为具有挑战性，旨在揭示模型的弱点。例如，表6中展示了两个案例及其关联的问题。</p>
<ul>
<li><strong>对于拉面示例</strong>，要正确回答餐厅的名称，模型需要具备广泛的知识覆盖和多语言理解能力；而要正确描述配菜，则可能需要从互联网检索相关的多模态信息。</li>
<li><strong>对于冰箱示例</strong>，要识别正确的酸奶品牌，模型需要处理高分辨率图像并具备丰富的知识覆盖。</li>
</ul>
<p>我们还观察到一个有趣的失败案例：当被问及冰箱中是否有草莓味酸奶时，LLaVA回答“是”，尽管冰箱中只有酸奶和草莓。这表明LLaVA有时会将图像视为“patches的集合”，未能理解图像中的复杂语义。我们希望LLaVA能作为这些基准的一个稳固基线，其研究结果能激励未来工作开发更强大的多模态模型。</p>
<p><img src="image-20241122165417053.png" alt></p>
<center>表 6：来自 LLaVA-Bench（In-the-Wild）的挑战性示例，我们为每张图像提供了极其详细的注释，以进行准确的评估。有些问题需要模型从高分辨率图像中提取细节并具有广泛的知识覆盖范围。</center>
<h3 id="52-scienceqa"><a class="markdownIt-Anchor" href="#52-scienceqa"></a> 5.2 ScienceQA</h3>
<p>ScienceQA包含21,000个<strong>多模态多项选择题</strong>，涵盖3个学科、26个主题、127个类别和379项技能。该基准数据集分为<strong>训练集</strong>、<strong>验证集</strong>和<strong>测试集</strong>，分别包含12,726个、4,241个和4,241个样本。</p>
<p>我们考虑了<strong>两种代表性方法</strong>，包括使用和不使用<strong>链式思维</strong>（CoT）的GPT-3.5模型（text-davinci-002）、LLaMA-Adapter以及<strong>多模态链式思维</strong>（MM-CoT），后者是当前在该数据集上的最先进方法。更多基准数据请参见<a target="_blank" rel="noopener" href="https://arxiv.org/abs/2209.09513%E3%80%82">https://arxiv.org/abs/2209.09513。</a></p>
<p>结果见表7。对于LLaVA，我们使用CLIP视觉编码器最后一层之前的视觉特征，让模型首先预测推理过程，然后是答案，并训练12个epoch。LLaVA的准确率为90.92%，非常接近最先进的91.68%。为了探索LLM的极限，我们还使用2-shot上下文学习提示GPT-4，获得了82.69%的准确率，相较于GPT-3.5的75.17%提高了7.52%。对于大量问题，我们发现GPT-4由于上下文不足（如缺少图像或图表）而无法回答。我们考虑了两种将LLaVA和GPT-4的输出结合的方案：</p>
<ol>
<li><strong>GPT-4补充方案</strong>：每当GPT-4无法提供答案时，我们使用LLaVA的预测结果。这种方案的准确率为90.97%，几乎与单独使用LLaVA相同；</li>
<li><strong>GPT-4作为裁判方案</strong>：每当GPT-4和LLaVA产生不同的答案时，我们再次提示GPT-4，要求其根据问题和两个结果提供最终答案。这种方法的思想类似于CoT，但融合了来自另一个模型的外部知识。令人惊讶的是，这种方案在所有问题类别上都能提供一致的提升，并实现了92.53%的新最先进准确率。<font color="red">有趣的是，无法处理图像的text-only GPT-4通过这一方案提高了模型在带有图像上下文问题上的整体表现。这是因为这些问题有些实际上不依赖于图像上下文即可得到正确答案。GPT-4裁判能够识别此类情况并纠正LLaVA的错误。</font>具体示例如附录中所示。据我们所知,这是 GPT-4 首次用于模型集成。我们希望这一发现能够鼓励未来的研究探索更有效的方法来利用LLM进行模型集成。</li>
</ol>
<p><img src="image-20241122193434267.png" alt></p>
<center>表 7：Science QA 数据集的准确性 (%)。问题类别：NAT = 自然科学、SOC = 社会科学、LAN = 语言科学、TXT = 文本上下文、IMG = 图像上下文、NO = 无上下文、G1-6 = 1-6 年级、G7-12 = 7-12 年级。 †纯文本 GPT-4，我们的评估。我们的新颖模型与纯文本 GPT-4 相结合，持续提高了模型在所有类别下的性能，设定了新的 SoTA 性能。</center>
<p><strong>消融实验</strong><br>
我们对ScienceQA进行了若干设计选择的消融实验，结果见表8。</p>
<p><img src="image-20241122193932852.png" alt></p>
<center>表 8：消融选择 (%)。与最佳变体的差异以红色文本报告</center>
<ol>
<li><strong>视觉特征</strong>：我们尝试使用CLIP视觉编码器的最后一层特征，得到了89.96%的准确率，比使用最后一层之前的特征（90.92%）低0.96%。<font color="red">我们假设这是因为CLIP的最后一层特征可能更侧重于全局和抽象的图像属性，而之前的层则可能更侧重于局部特征，这些对于理解特定图像细节更有用。</font></li>
<li><strong>链式思维</strong>：为了决定模型预测中推理过程和答案的顺序，我们运行了两种变体，观察到答案先行<font color="red">(先给出这么预测理由再给出预测结果）</font>的策略在12个epoch时报告了89.77%的最佳准确率，而推理先行策略在6个epoch时迅速达到89.77%的准确率，但更多的训练没有带来额外的提升。我们得出结论，类似于CoT的推理先行策略可以大大加速收敛，但对最终性能贡献较小。</li>
<li><strong>预训练</strong>：我们跳过预训练，直接在ScienceQA上从头开始训练，准确率下降到85.81%。5.11%的绝对下降表明，我们的预训练阶段对于对齐多模态特征并保持广泛的预训练知识至关重要。</li>
<li><strong>模型规模</strong>：我们保持与最佳13B模型相同的配置，训练了一个7B模型。结果为89.84%的准确率，比90.92%低1.08%，表明模型规模的重要性。</li>
</ol>
<h2 id="6-结论"><a class="markdownIt-Anchor" href="#6-结论"></a> 6. 结论</h2>
<ul>
<li>本文展示了视觉指令调优的有效性。我们提出了一种自动化流程，用于生成语言-图像指令跟随数据。</li>
<li>在此基础上，我们训练了LLaVA，这是一种能够根据人类意图完成视觉任务的多模态模型。</li>
<li>当在ScienceQA数据集上进行微调时，LLaVA达到了新的最先进（SoTA）准确率，并且在多模态聊天数据上微调后展现出了出色的视觉聊天能力。</li>
<li>此外，我们还首次提出了一个基准，用于研究多模态指令跟随能力。</li>
</ul>
<p>本文是视觉指令调优的初步探索，主要关注于现实生活中的任务。有关LLaVA在学术基准上的更多量化结果，请参阅改进的基线研究<a target="_blank" rel="noopener" href="https://arxiv.org/abs/2310.03744%E3%80%82%E6%88%91%E4%BB%AC%E5%B8%8C%E6%9C%9B%E6%9C%AC%E7%A0%94%E7%A9%B6%E8%83%BD%E5%A4%9F%E6%BF%80%E5%8A%B1%E6%9C%AA%E6%9D%A5%E7%A0%94%E7%A9%B6%EF%BC%8C%E6%8E%A8%E5%8A%A8%E6%9B%B4%E5%BC%BA%E5%A4%A7%E5%A4%9A%E6%A8%A1%E6%80%81%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BC%80%E5%8F%91%E3%80%82">https://arxiv.org/abs/2310.03744。我们希望本研究能够激励未来研究，推动更强大多模态模型的开发。</a></p>
<h2 id="附录"><a class="markdownIt-Anchor" href="#附录"></a> 附录</h2>
<h3 id="a-更广泛的影响"><a class="markdownIt-Anchor" href="#a-更广泛的影响"></a> A. 更广泛的影响</h3>
<p>LLaVA（通用视觉助手）的开发和发布可能带来潜在的益处和风险。由于其视觉相关特性，LLaVA有一些独特的考虑，同时也继承了现有指令跟随语言模型（如Alpaca、Vicuna等）的共性问题。LLaVA基于LLaMA、Vicuna和CLIP构建，因此也继承了LLM和视觉编码器相关的一些问题。以下概述了风险和相关的缓解策略：</p>
<ol>
<li>
<p><strong>恶意输入</strong><br>
为了尽量减少潜在的滥用和有害后果，我们为LLaVA采用了两种预防措施：</p>
<ul>
<li>使用OpenAI过滤器API对用户文本输入进行筛查，防止处理有害或不当的文本指令。</li>
<li>对上传的用户图像应用NSFW（不适合工作场所）过滤器，以检测并阻止可能有害的图像内容。</li>
</ul>
</li>
<li>
<p><strong>幻觉</strong><br>
与LLMs类似，LLaVA可能生成并非基于事实或输入数据的输出。这在关键应用（如医学领域）中尤其令人担忧。</p>
</li>
<li>
<p><strong>偏见</strong><br>
偏见可能从基础模型传递到LLaVA，包括来自视觉编码器（CLIP）和语言解码器（LLaMA/Vicuna）的偏见。这可能导致输出的结果存在偏见或不公平的内容表示。</p>
</li>
<li>
<p><strong>能源消耗</strong><br>
尽管LLaVA的预训练数据集规模较小（详见附录C），能源消耗问题并不显著，但如果在扩大预训练数据集或增加模型规模（如扩展至更大的LLaMA 65B模型）时，可能成为一个问题。</p>
</li>
<li>
<p><strong>评估复杂性</strong></p>
<p>评估LLaVA的性能具有挑战性，因为它涉及语言和视觉任务。我们的评估基准涵盖多个方面，包括<strong>准确性</strong>、<strong>概念覆盖</strong>、<strong>推理能力</strong>和<strong>创造力</strong>。然而，还需要考虑其他方面，例如视觉内容幻觉的程度以及对视觉内容的细粒度理解。在我们的研究中，基于文本的GPT-4多模态评估表现出一致性和准确性，但其在不同情境下的稳健性以及评估其他尚未探索方面的能力仍是未来研究的课题。</p>
</li>
</ol>
<p>尽管存在这些风险，我们相信将LLaVA发布给研究社区的益处大于潜在的危害。这一发布能够支持对模型的持续研究与改进，并促使社区共同开发更好的缓解策略来应对这些问题。此外，LLaVA的发布可以推动新应用和研究方向的发展，最终为视觉-语言任务中基础模型的进步和负责任的部署做出贡献。</p>
<h3 id="b-更多结果"><a class="markdownIt-Anchor" href="#b-更多结果"></a> B. 更多结果</h3>
<p>我们展示了LLaVA的更多定性结果，以分析其突现行为和观察到的弱点。有关LLaVA在学术基准上的更多量化结果，请参考基于视觉指令调优的改进基线<a target="_blank" rel="noopener" href="https://arxiv.org/abs/2310.03744%E3%80%82">https://arxiv.org/abs/2310.03744。</a></p>
<ul>
<li>在表9中，LLaVA在GPT-4论文中的另一个示例中表现出类似的行为。与OpenAI的GPT-4在线演示类似，LLaVA能够根据图2中的简化用户输入草图生成一个互动笑话网站的HTML/JS/CSS代码，尽管存在一些小错误。</li>
<li>如图3所示，LLaVA可以以对话式的方式遵循用户指令，提供详细的回答或创意写作。</li>
<li>此外，LLaVA能够将视觉内容与预训练LLM中的文本知识联系起来，如图4和图5所示。</li>
<li>一个有趣的突现行为是，LLaVA能够理解训练中未覆盖的视觉内容。例如，在图6中，它能够识别Elon Musk，无论是在头像照片中还是在他打扮成Doge的幽默表情包中，尽管Elon Musk并未出现在LLaVA的视觉特征对齐或视觉指令调优阶段的训练数据中。</li>
<li>LLaVA还展示了令人印象深刻的OCR（光学字符识别）能力，如表9和图2所示，而这在我们的训练数据中很少涉及。</li>
</ul>
<p>我们希望这些额外的结果和观察能够展示LLaVA在各类应用领域的潜力。未来的工作中，有必要更深入地研究这些突现行为，理解其背后的机制，这使得LLaVA能够展现出如此强的泛化能力。这将为构建更优秀的多模态语言模型（LMMs）铺平道路，包括增强鲁棒性、减少偏差、改进对齐能力以及扩展视觉-语言表示的范围。</p>
<p><img src="image-20241122195258357.png" alt></p>
<center>表 9：Example prompt比较 LLaVA、GPT-4、BLIP-2 和 OpenFlamingo 在理解幽默方面的视觉推理能力。 BLIP-2 和 OpenFlamingo 未能遵循用户的指示。 LLaVA 和 GPT-4 都解释了这个模因及其幽默，而 GPT-4 给出了更简洁的答案。</center>
<p><img src="image-20241122195752941.png" alt></p>
<center>图 2：LLaVA 根据用户草图输入生成交互式网站的 HTML/JS 代码。修复生成的输出中的小错误（红色）后，交互式界面即可工作。 LLaVA 的输出还有改进的空间，例如将笑话和妙语分成两行，并且仅在单击按钮时显示妙语，以更好地反映用户的意图。</center>
<p><img src="image-20241122195931341.png" alt></p>
<center>图 3：LLaVA 能够根据用户的意图识别视觉内容，而无需直接提示进行视觉识别。当提示后续请求时，它还会提供详细的响应，并且生成的响应与所提供的视觉内容密切相关。</center>
<p><img src="image-20241122200107602.png" alt></p>
<center>图 4：LLaVA 将电影场景与来自预训练的 LLM 的文本知识联系起来。</center>
<p><img src="image-20241122200147756.png" alt></p>
<center>图 5：LLaVA 识别出达芬奇的著名艺术作品《蒙娜丽莎》。当我们开始新的对话时，它还会解释网络上模仿蒙娜丽莎的幽默艺术作品。</center>
<p><img src="image-20241122200237649.png" alt></p>
<center>图6：LLaVA的一个有趣的突现行为是它能够识别Elon Musk，无论是在头像照片中还是在他打扮成Doge的幽默表情包中。这表明预训练的CLIP视觉编码器可能见过Elon Musk的图像。然而，这仍然令人惊讶，因为Elon Musk从未出现在LLaVA的视觉特征对齐或视觉指令调优阶段的训练数据中，这表明基础语言模型能够对未见过的视觉概念进行泛化。</center>
<p><img src="image-20241122200633201.png" alt></p>
<center>表10：一个示例展示了text only GPT-4如何作为裁判，将LLaVA和仅文本GPT-4的预测结果进行整合，并给出正确的最终答案。</center>
<h3 id="c-训练细节"><a class="markdownIt-Anchor" href="#c-训练细节"></a> C. 训练细节</h3>
<ul>
<li>我们在过滤后的CC-595K子集上对模型进行了1个epoch的预训练，学习率为2e-3，批量大小为128；</li>
<li>然后在提出的LLaVA-Instruct-158K数据集上进行了3个epoch的微调，学习率为2e-5，批量大小为32。</li>
<li>按照Vicuna的设置，我们使用Adam优化器，不进行权重衰减，并采用余弦学习率调度，warmup比例为3%。</li>
<li>在微调过程中，为了节省GPU内存，我们使用了FSDP（全分片数据并行）和梯度检查点技术，但未使用数据卸载。</li>
<li>启用了BF16和TF32，以在速度和精度之间取得平衡。</li>
<li>所有模型均使用8块A100 GPU进行训练。CC-595K的预训练在4小时内完成，Instruct-158K的微调在10小时内完成，ScienceQA的微调在4小时内完成。</li>
</ul>
<h3 id="d-资源"><a class="markdownIt-Anchor" href="#d-资源"></a> D. 资源</h3>
<p>我们的源代码、生成的指令调优数据和提出的基准已上传至匿名GitHub仓库：<a target="_blank" rel="noopener" href="https://github.com/LLaVA-Annonymous/LLaVA%E3%80%82">https://github.com/LLaVA-Annonymous/LLaVA。</a></p>
<ol>
<li><strong>源代码</strong>：<a target="_blank" rel="noopener" href="https://github.com/LLaVA-Annonymous/LLaVA">https://github.com/LLaVA-Annonymous/LLaVA</a></li>
<li><strong>README</strong>：<a target="_blank" rel="noopener" href="https://github.com/LLaVA-Annonymous/LLaVA">https://github.com/LLaVA-Annonymous/LLaVA</a></li>
<li><strong>启动演示的说明</strong>：<a target="_blank" rel="noopener" href="https://github.com/LLaVA-Annonymous/LLaVA#web-ui">https://github.com/LLaVA-Annonymous/LLaVA#web-ui</a></li>
<li><strong>用于查询GPT-4的所有提示和少样本示例</strong>：<a target="_blank" rel="noopener" href="https://github.com/LLaVA-Annonymous/LLaVA/tree/master/playground/data/prompts">https://github.com/LLaVA-Annonymous/LLaVA/tree/master/playground/data/prompts</a></li>
<li><strong>LLaVA-Instruct-158K</strong>：<a target="_blank" rel="noopener" href="https://github.com/LLaVA-Annonymous/LLaVA/blob/master/playground/data/llava_instruct_150k.json">https://github.com/LLaVA-Annonymous/LLaVA/blob/master/playground/data/llava_instruct_150k.json</a></li>
<li><strong>LLaVA-Bench</strong>：<a target="_blank" rel="noopener" href="https://github.com/LLaVA-Annonymous/LLaVA/blob/master/playground/data/coco2014_val_gpt4_qa_30x3.jsonl%E5%92%8Chttps://github.com/LLaVA-Annonymous/LLaVA/tree/master/playground/data/llava_bench_in_the_wild">https://github.com/LLaVA-Annonymous/LLaVA/blob/master/playground/data/coco2014_val_gpt4_qa_30x3.jsonl和https://github.com/LLaVA-Annonymous/LLaVA/tree/master/playground/data/llava_bench_in_the_wild</a></li>
<li><strong>模型检查点</strong>：压缩后的模型检查点大小为25GB，超过了GitHub LFS（大文件存储）的5GB限制。我们会将检查点公开发布，或者根据本次提交的评审请求提供。</li>
</ol>
<h3 id="e-数据"><a class="markdownIt-Anchor" href="#e-数据"></a> E. 数据</h3>
<p><strong>简要图像描述的指令</strong>:用于简要描述图像内容的指令列表如表11所示。它们表达了相同的含义，但具有自然语言的多样性。</p>
<p><img src="image-20241122201144433.png" alt></p>
<center>表 11：简要图像描述的指令列表。</center>
<p><strong>详细图像描述的指令</strong>:用于详细描述图像内容的指令列表如表12所示。这些指令表达了相同的含义，但具有自然语言的多样性。</p>
<p><img src="image-20241122201228416.png" alt></p>
<center>表 12：详细图像描述的指令列表。</center>
<p><strong>CC3M数据集</strong>:我们使用Spacy对整个CC3M数据集的每个标题提取名词短语，并统计每个唯一名词短语的频率。</p>
<ol>
<li>我们跳过频率小于3的名词短语，因为这些通常是罕见的概念和属性组合，而这些组合通常已在其他标题中被覆盖。</li>
<li>然后，我们从频率最低的名词短语开始，将包含该名词短语的标题添加到候选池中。</li>
<li>如果名词短语的频率大于100，则从所有包含该短语的标题中随机选择一个大小为100的子集。最终得到了大约595K的图像-文本对。</li>
</ol>
<p>CC3M数据集在过滤前后名词短语统计的对比如图7所示。过滤后的数据集在频率大于3的概念上具有良好的覆盖率，但图像-文本对的数量较少。</p>
<p><img src="image-20241122201558641.png" alt></p>
<center>图 7：CC3M 过滤前后的名词短语统计数据比较。图例中报告了独特名词短语的总数。</center>
<h3 id="f-提示"><a class="markdownIt-Anchor" href="#f-提示"></a> F. 提示</h3>
<p>用于从 ChatGPT/GPT-4 生成基于图像的对话的提示如表 13 所示。</p>
<p><img src="image-20241122201635879.png" alt></p>
<center>表13：对于每个query，我们展示了如何构建用于ChatGPT/GPT-4的提示，以通过少样本的上下文学习从查询的context中收集查询的response。这些示例来自fewshot_samples，每个示例都包含输入的context和输出的response。请注意，messages是最终的提示。
    在此示例中，我们提供了用于生成对话回复的提示。有关其上下文学习的示例，请参见表15和表16了解详细信息。我们建议读者查看代码库以获取用于生成其他两种类型回复（包括详细描述和复杂推理）的提示。</center>
<p><img src="image-20241122201736955.png" alt></p>
<center>表14：一个示例，用于说明指令跟随数据的构造。顶部区域展示了用于提示GPT的上下文信息，例如标题和边界框；底部区域展示了三种类型的回复。请注意，视觉图像并未用于提示GPT，仅在此作为参考显示。</center>
<p><img src="image-20241122201803320.png" alt></p>
<center>表15：一个示例，展示如何在上下文学习中构造视觉对话数据。<img src="image-20241122201812911.png" alt><p></p>
<center>表15：一个示例，展示如何在上下文学习中构造视觉对话数据。</center>
</center></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">HUI</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/12/10/Multimodel/LLaVA/">http://example.com/2024/12/10/Multimodel/LLaVA/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">HUI</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/image-20241122154508143.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/12/10/Multimodel/LLaVA-V1.5/" title="LLaVA(2)-Improved Baselines with Visual Instruction Tuning"><img class="cover" src="/img/image-20241123214150206.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">LLaVA(2)-Improved Baselines with Visual Instruction Tuning</div></div></a></div><div class="next-post pull-right"><a href="/2024/12/10/Multimodel/PMC-CLIP/" title="MICCAI2024(1)-PMC-CLIP"><img class="cover" src="/img/image-20241111141331709.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MICCAI2024(1)-PMC-CLIP</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div class="comment-switch"><span class="first-comment">Valine</span><span id="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/87788970_p0_master1200.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">HUI</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/kalabiqlx" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:kalabiqlx@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#llava-visual-instruction-tuning"><span class="toc-text"> LLaVA-Visual Instruction Tuning</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%98%E8%A6%81"><span class="toc-text"> 摘要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BC%95%E8%A8%80"><span class="toc-text"> 1. 引言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%9B%B8%E5%85%B3%E5%B7%A5%E4%BD%9C"><span class="toc-text"> 2. 相关工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-gpt%E8%BE%85%E5%8A%A9%E7%9A%84%E8%A7%86%E8%A7%89%E6%8C%87%E4%BB%A4%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90"><span class="toc-text"> 3. GPT辅助的视觉指令数据生成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%A7%86%E8%A7%89%E6%8C%87%E4%BB%A4%E5%BE%AE%E8%B0%83"><span class="toc-text"> 4. 视觉指令微调</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-%E6%9E%B6%E6%9E%84"><span class="toc-text"> 4.1 架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-%E8%AE%AD%E7%BB%83"><span class="toc-text"> 4.2 训练</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%AE%9E%E9%AA%8C"><span class="toc-text"> 5. 实验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#51-%E5%A4%9A%E6%A8%A1%E6%80%81%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA"><span class="toc-text"> 5.1 多模态聊天机器人</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#52-scienceqa"><span class="toc-text"> 5.2 ScienceQA</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%BB%93%E8%AE%BA"><span class="toc-text"> 6. 结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-text"> 附录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a-%E6%9B%B4%E5%B9%BF%E6%B3%9B%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-text"> A. 更广泛的影响</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b-%E6%9B%B4%E5%A4%9A%E7%BB%93%E6%9E%9C"><span class="toc-text"> B. 更多结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c-%E8%AE%AD%E7%BB%83%E7%BB%86%E8%8A%82"><span class="toc-text"> C. 训练细节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#d-%E8%B5%84%E6%BA%90"><span class="toc-text"> D. 资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e-%E6%95%B0%E6%8D%AE"><span class="toc-text"> E. 数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#f-%E6%8F%90%E7%A4%BA"><span class="toc-text"> F. 提示</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/12/10/Multimodel/MM-LLMs-survey/" title="MM-LLMs综述(腾讯)"><img src="/img/image-20241114140927375.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MM-LLMs综述(腾讯)"/></a><div class="content"><a class="title" href="/2024/12/10/Multimodel/MM-LLMs-survey/" title="MM-LLMs综述(腾讯)">MM-LLMs综述(腾讯)</a><time datetime="2024-12-10T12:40:00.000Z" title="发表于 2024-12-10 20:40:00">2024-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/10/Multimodel/BiRD/" title="MICCAI2024(2)-BIRD"><img src="/img/image-20241104164541942.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MICCAI2024(2)-BIRD"/></a><div class="content"><a class="title" href="/2024/12/10/Multimodel/BiRD/" title="MICCAI2024(2)-BIRD">MICCAI2024(2)-BIRD</a><time datetime="2024-12-10T12:36:38.000Z" title="发表于 2024-12-10 20:36:38">2024-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/10/Multimodel/LLaVA-V1.5/" title="LLaVA(2)-Improved Baselines with Visual Instruction Tuning"><img src="/img/image-20241123214150206.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLaVA(2)-Improved Baselines with Visual Instruction Tuning"/></a><div class="content"><a class="title" href="/2024/12/10/Multimodel/LLaVA-V1.5/" title="LLaVA(2)-Improved Baselines with Visual Instruction Tuning">LLaVA(2)-Improved Baselines with Visual Instruction Tuning</a><time datetime="2024-12-10T12:30:38.000Z" title="发表于 2024-12-10 20:30:38">2024-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/10/Multimodel/LLaVA/" title="LLaVA(1)-Visual Instruction Tuning"><img src="/img/image-20241122154508143.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLaVA(1)-Visual Instruction Tuning"/></a><div class="content"><a class="title" href="/2024/12/10/Multimodel/LLaVA/" title="LLaVA(1)-Visual Instruction Tuning">LLaVA(1)-Visual Instruction Tuning</a><time datetime="2024-12-10T12:25:38.000Z" title="发表于 2024-12-10 20:25:38">2024-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/10/Multimodel/PMC-CLIP/" title="MICCAI2024(1)-PMC-CLIP"><img src="/img/image-20241111141331709.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MICCAI2024(1)-PMC-CLIP"/></a><div class="content"><a class="title" href="/2024/12/10/Multimodel/PMC-CLIP/" title="MICCAI2024(1)-PMC-CLIP">MICCAI2024(1)-PMC-CLIP</a><time datetime="2024-12-10T12:12:38.000Z" title="发表于 2024-12-10 20:12:38">2024-12-10</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/image-20241122154508143.png')"><div id="footer-wrap"><div class="copyright">&copy;2024 By HUI</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><script>(() => {
  const disqus_config = function () {
    this.page.url = 'http://example.com/2024/12/10/Multimodel/LLaVA/'
    this.page.identifier = '/2024/12/10/Multimodel/LLaVA/'
    this.page.title = 'LLaVA(1)-Visual Instruction Tuning'
  }

  const disqusReset = () => {
    window.DISQUS && window.DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  btf.addGlobalFn('themeChange', disqusReset, 'disqus')

  const loadDisqus = () =>{
    if (window.DISQUS) disqusReset()
    else {
      const script = document.createElement('script')
      script.src = 'https://.disqus.com/embed.js'
      script.setAttribute('data-timestamp', +new Date())
      document.head.appendChild(script)
    }
  }

  const getCount = async() => {
    try {
      const eleGroup = document.querySelector('#post-meta .disqus-comment-count')
      if (!eleGroup) return
      const cleanedLinks = eleGroup.href.replace(/#post-comment$/, '')

      const res = await fetch(`https://disqus.com/api/3.0/threads/set.json?forum=&api_key=&thread:link=${cleanedLinks}`,{
        method: 'GET'
      })
      const result = await res.json()

      const count = result.response.length ? result.response[0].posts : 0
      eleGroup.textContent = count
    } catch (err) {
      console.error(err)
    }
  }

  if ('Valine' === 'Disqus' || !false) {
    if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
    else {
      loadDisqus()
      GLOBAL_CONFIG_SITE.isPost && getCount()
    }
  } else {
    window.loadOtherComment = loadDisqus
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>